# Grid View 功能对齐实施计划

> **目标**: 在 1-2 个月内完成核心功能对齐
> 
> 创建时间: 2025-10-09

---

## 📋 总览

### 实施范围

**短期目标（1-2 周）**: Grid View 核心功能
- ✅ Filter（过滤）
- ✅ Sort（排序）
- ✅ 记录详情展开
- ✅ CSV 导入

**中期目标（1-2 个月）**: 关键字段类型
- ✅ Attachment 字段
- ✅ Link 字段
- ✅ Lookup 字段

### 预期成果

- **完成度**: 从 35% 提升到 75%
- **可用性**: 达到生产环境标准
- **用户体验**: 基本对齐旧系统

---

## 🎯 第一阶段：Grid View 核心功能（Week 1-2）

### 1. Filter（过滤）功能

#### 📝 需求分析

**参考旧系统实现**:
- 位置: `apps/nextjs-app/src/features/app/blocks/view/grid/`
- 过滤器类型: 文本、数字、日期、选择等
- UI 组件: 过滤器面板、条件构建器

**核心功能**:
```typescript
interface IFilter {
  fieldId: string
  operator: FilterOperator  // 'is', 'isNot', 'contains', 'isEmpty', etc.
  value: any
}

enum FilterOperator {
  Is = 'is',
  IsNot = 'isNot',
  Contains = 'contains',
  DoesNotContain = 'doesNotContain',
  IsEmpty = 'isEmpty',
  IsNotEmpty = 'isNotEmpty',
  // 数字类型
  GreaterThan = 'greaterThan',
  LessThan = 'lessThan',
  // 日期类型
  IsAfter = 'isAfter',
  IsBefore = 'isBefore',
  // ... 更多
}
```

#### 🏗️ 实施步骤

**Day 1-2: UI 设计和组件开发**
- [ ] 创建 `FilterPanel` 组件
- [ ] 创建 `FilterCondition` 组件
- [ ] 创建 `OperatorSelect` 组件
- [ ] 创建 `ValueInput` 组件（根据字段类型动态渲染）

**Day 3-4: 过滤逻辑实现**
- [ ] 实现客户端过滤函数
- [ ] 实现多条件组合（AND/OR）
- [ ] 集成到 Grid 组件

**Day 5: 测试和优化**
- [ ] 单元测试
- [ ] 性能测试（大数据量）
- [ ] UI/UX 优化

#### 📦 文件结构

```
src/components/
  ├── filter/
  │   ├── FilterPanel.tsx
  │   ├── FilterCondition.tsx
  │   ├── OperatorSelect.tsx
  │   ├── ValueInput.tsx
  │   ├── types.ts
  │   └── utils.ts
  └── FullFeaturedDemo.tsx  # 更新集成
```

#### 🔍 关键技术点

1. **动态操作符**: 根据字段类型显示不同的操作符
2. **值输入器**: 根据字段类型渲染不同的输入组件
3. **性能优化**: 使用 useMemo 缓存过滤结果
4. **持久化**: 将过滤条件保存到 localStorage

---

### 2. Sort（排序）功能

#### 📝 需求分析

**参考旧系统实现**:
- 位置: `apps/nextjs-app/src/features/app/blocks/view/grid/`
- 支持多字段排序
- 支持升序/降序

**核心功能**:
```typescript
interface ISort {
  fieldId: string
  order: 'asc' | 'desc'
}

interface ISortConfig {
  sorts: ISort[]
  manualSort?: boolean
}
```

#### 🏗️ 实施步骤

**Day 6-7: UI 组件**
- [ ] 创建 `SortPanel` 组件
- [ ] 在列头添加排序指示器
- [ ] 创建排序拖拽重排序

**Day 8-9: 排序逻辑**
- [ ] 实现多字段排序算法
- [ ] 支持自定义排序比较器
- [ ] 集成到 Grid 组件

**Day 10: 测试**
- [ ] 各种数据类型排序测试
- [ ] 性能测试
- [ ] 边界情况测试

#### 📦 文件结构

```
src/components/
  ├── sort/
  │   ├── SortPanel.tsx
  │   ├── SortIndicator.tsx
  │   ├── types.ts
  │   └── utils.ts
  └── FullFeaturedDemo.tsx
```

#### 🔍 关键技术点

1. **稳定排序**: 保证排序稳定性
2. **多字段排序**: 支持按多个字段依次排序
3. **性能**: 大数据量下的排序优化
4. **用户体验**: 点击列头快速排序

---

### 3. 记录详情展开

#### 📝 需求分析

**参考旧系统实现**:
- 位置: `apps/nextjs-app/src/features/app/components/expand-record-container/`
- 模态框或侧边栏展示
- 支持完整编辑
- 显示所有字段

**核心功能**:
```typescript
interface IRecordDetail {
  recordId: string
  tableId: string
  fields: IField[]
  values: Record<string, any>
  onUpdate: (fieldId: string, value: any) => void
  onClose: () => void
}
```

#### 🏗️ 实施步骤

**Day 11-12: UI 设计**
- [ ] 创建 `RecordDetailModal` 组件
- [ ] 创建 `FieldEditor` 组件集合
- [ ] 响应式布局设计

**Day 13: 数据集成**
- [ ] 获取完整记录数据
- [ ] 实现字段更新
- [ ] 实时同步到 Grid

**Day 14: 增强功能**
- [ ] 添加键盘快捷键（ESC 关闭，Enter 保存）
- [ ] 添加前一条/后一条导航
- [ ] 添加删除记录功能

#### 📦 文件结构

```
src/components/
  ├── record-detail/
  │   ├── RecordDetailModal.tsx
  │   ├── RecordDetailSidebar.tsx
  │   ├── FieldEditorFactory.tsx
  │   ├── editors/
  │   │   ├── TextFieldEditor.tsx
  │   │   ├── NumberFieldEditor.tsx
  │   │   ├── SelectFieldEditor.tsx
  │   │   └── ... 更多
  │   └── types.ts
  └── FullFeaturedDemo.tsx
```

#### 🔍 关键技术点

1. **模态框管理**: 使用 Dialog 组件
2. **表单验证**: 必填项、格式验证
3. **乐观更新**: 先更新 UI，后台同步
4. **错误处理**: 保存失败回滚

---

### 4. CSV 导入

#### 📝 需求分析

**参考旧系统实现**:
- 位置: `apps/nestjs-backend/src/features/import/`
- 支持 CSV 文件解析
- 字段映射
- 批量导入

**核心功能**:
```typescript
interface IImportConfig {
  file: File
  fieldMapping: Record<string, string>  // CSV列 -> 字段ID
  skipFirstRow: boolean
  onProgress: (progress: number) => void
}
```

#### 🏗️ 实施步骤

**Day 11-12: 文件解析**
- [ ] 使用 PapaParse 解析 CSV
- [ ] 文件预览功能
- [ ] 字段自动匹配

**Day 13: 数据导入**
- [ ] 批量创建记录 API
- [ ] 进度显示
- [ ] 错误处理和报告

**Day 14: 优化**
- [ ] 大文件处理（分批导入）
- [ ] 数据验证
- [ ] 导入历史记录

#### 📦 文件结构

```
src/components/
  ├── import/
  │   ├── ImportDialog.tsx
  │   ├── FileUploader.tsx
  │   ├── FieldMapper.tsx
  │   ├── ImportProgress.tsx
  │   └── utils/
  │       ├── csvParser.ts
  │       └── fieldMatcher.ts
  └── FullFeaturedDemo.tsx
```

#### 🔍 关键技术点

1. **CSV 解析**: 处理各种格式和编码
2. **智能匹配**: 自动匹配字段名
3. **批量处理**: 分批导入避免阻塞
4. **进度反馈**: 实时显示导入进度

---

## 🎯 第二阶段：关键字段类型（Week 3-8）

### 5. Attachment 字段

#### 📝 需求分析

**参考旧系统实现**:
- 位置: `apps/nestjs-backend/src/features/attachments/`
- 文件上传服务
- 附件预览
- 多文件支持

**核心功能**:
```typescript
interface IAttachment {
  id: string
  name: string
  size: number
  type: string
  url: string
  thumbnailUrl?: string
}

interface IAttachmentField {
  type: 'attachment'
  value: IAttachment[]
  maxFiles?: number
  maxSize?: number
  allowedTypes?: string[]
}
```

#### 🏗️ 实施步骤

**Week 3: 后端服务（5 天）**
- [ ] 实现文件上传 API
- [ ] 实现文件存储（本地/云存储）
- [ ] 实现缩略图生成
- [ ] 实现文件删除 API

**Week 4: 前端组件（5 天）**
- [ ] 创建 `AttachmentCell` 组件
- [ ] 创建 `AttachmentEditor` 组件
- [ ] 拖拽上传支持
- [ ] 预览功能（图片、PDF）

**测试和优化（2 天）**
- [ ] 大文件上传测试
- [ ] 并发上传测试
- [ ] 安全性测试

#### 📦 文件结构

```
后端:
src/features/
  └── attachment/
      ├── attachment.controller.ts
      ├── attachment.service.ts
      └── storage/
          ├── local-storage.service.ts
          └── cloud-storage.service.ts

前端:
src/components/
  └── field-types/
      └── attachment/
          ├── AttachmentCell.tsx
          ├── AttachmentEditor.tsx
          ├── AttachmentPreview.tsx
          └── FileUploader.tsx
```

---

### 6. Link 字段

#### 📝 需求分析

**参考旧系统实现**:
- 位置: `apps/nestjs-backend/src/features/calculation/link.service.ts`
- 表间关联
- 一对多、多对多关系
- 双向同步

**核心功能**:
```typescript
interface ILinkField {
  type: 'link'
  linkedTableId: string
  linkedFieldId?: string  // 反向链接字段
  relationshipType: 'oneToMany' | 'manyToMany'
  value: Array<{
    recordId: string
    title: string
  }>
}
```

#### 🏗️  实施步骤

**Week 5-6: 后端实现（10 天）**
- [ ] 数据库关系表设计
- [ ] Link 字段创建 API
- [ ] 记录关联 API
- [ ] 反向链接自动创建
- [ ] 关联记录查询优化

**Week 7: 前端组件（5 天）**
- [ ] 创建 `LinkCell` 组件
- [ ] 创建 `LinkEditor` 组件（记录选择器）
- [ ] 关联记录预览
- [ ] 快速添加功能

**测试（2 天）**
- [ ] 关系完整性测试
- [ ] 删除级联测试
- [ ] 性能测试

#### 📦 文件结构

```
后端:
src/features/
  └── link/
      ├── link.controller.ts
      ├── link.service.ts
      └── link-relation.service.ts

前端:
src/components/
  └── field-types/
      └── link/
          ├── LinkCell.tsx
          ├── LinkEditor.tsx
          ├── RecordSelector.tsx
          └── LinkedRecordList.tsx
```

---

### 7. Lookup 字段

#### 📝 需求分析

**参考旧系统实现**:
- 位置: `apps/nestjs-backend/src/features/field/field-calculate/`
- 基于 Link 字段
- 跨表查找数据
- 自动更新

**核心功能**:
```typescript
interface ILookupField {
  type: 'lookup'
  linkFieldId: string      // 关联字段ID
  lookupFieldId: string    // 要查找的字段ID
  value: any               // 查找结果
}
```

#### 🏗️ 实施步骤

**Week 8: 实现（7 天）**
- [ ] 后端 Lookup 计算服务
- [ ] 依赖追踪系统
- [ ] 自动更新机制
- [ ] 前端 LookupCell 组件
- [ ] 配置 UI

**测试（3 天）**
- [ ] 复杂查找场景测试
- [ ] 更新触发测试
- [ ] 性能测试

#### 📦 文件结构

```
后端:
src/features/
  └── lookup/
      ├── lookup.service.ts
      └── lookup-calculation.service.ts

前端:
src/components/
  └── field-types/
      └── lookup/
          ├── LookupCell.tsx
          └── LookupConfig.tsx
```

---

## 📊 进度追踪

### Week 1
- [ ] Day 1-2: Filter UI
- [ ] Day 3-4: Filter 逻辑
- [ ] Day 5: Filter 测试

### Week 2
- [ ] Day 6-7: Sort UI
- [ ] Day 8-9: Sort 逻辑
- [ ] Day 10: Sort 测试
- [ ] Day 11-14: 记录详情 & CSV 导入

### Week 3-4
- [ ] Attachment 后端
- [ ] Attachment 前端

### Week 5-7
- [ ] Link 字段完整实现

### Week 8
- [ ] Lookup 字段实现

---

## 🎯 里程碑

### Milestone 1: 核心功能完成（Week 2 结束）
**验收标准**:
- ✅ 可以过滤数据
- ✅ 可以排序数据
- ✅ 可以查看记录详情
- ✅ 可以导入 CSV

**完成度**: 35% → 55%

### Milestone 2: 文件管理（Week 4 结束）
**验收标准**:
- ✅ 可以上传附件
- ✅ 可以预览附件
- ✅ 附件存储稳定

**完成度**: 55% → 65%

### Milestone 3: 关联功能（Week 7 结束）
**验收标准**:
- ✅ 可以关联记录
- ✅ 双向同步正常
- ✅ 关联记录可查看

**完成度**: 65% → 73%

### Milestone 4: 完整计算（Week 8 结束）
**验收标准**:
- ✅ Lookup 字段可用
- ✅ 自动更新正常
- ✅ 性能可接受

**完成度**: 73% → 75%

---

## 🔧 技术栈和工具

### 前端
- React + TypeScript
- Vite (构建工具)
- @teable/grid-table-kanban (Grid 组件)
- shadcn/ui (UI 组件)
- Papa Parse (CSV 解析)
- React Query (数据管理)

### 后端
- Node.js + Express/Fastify
- Prisma (ORM)
- PostgreSQL (数据库)
- Multer (文件上传)

### 开发工具
- ESLint + Prettier
- Jest (单元测试)
- Vitest (组件测试)
- Playwright (E2E 测试)

---

## 📝 开发规范

### 代码规范
1. **TypeScript 优先**: 所有新代码必须使用 TypeScript
2. **组件化**: 遵循单一职责原则，组件粒度合理
3. **类型安全**: 避免使用 `any`，充分利用类型系统
4. **性能优化**: 使用 `useMemo`、`useCallback` 优化性能

### Git 工作流
1. **分支命名**: `feature/filter-functionality`
2. **提交信息**: 遵循 Conventional Commits
3. **代码审查**: 所有 PR 需要审查后合并

### 测试要求
1. **单元测试**: 核心逻辑必须有单元测试
2. **组件测试**: 关键组件需要测试
3. **E2E 测试**: 主要流程需要端到端测试
4. **覆盖率**: 目标 80% 以上

---

## 🚨 风险和挑战

### 技术风险
1. **性能问题**: 大数据量下的过滤和排序性能
   - 缓解: 虚拟滚动 + 分页
   
2. **文件存储**: 大文件上传和存储
   - 缓解: 使用云存储服务
   
3. **关联复杂度**: Link 字段的双向同步
   - 缓解: 参考旧系统实现，充分测试

### 时间风险
1. **估算偏差**: 功能实现可能超出预期时间
   - 缓解: 每周回顾调整计划
   
2. **依赖阻塞**: 某些功能相互依赖
   - 缓解: 提前识别依赖，并行开发

---

## 📚 参考资源

### 旧系统代码
- Grid View: `teable-develop/apps/nextjs-app/src/features/app/blocks/view/grid/`
- 字段服务: `teable-develop/apps/nestjs-backend/src/features/field/`
- 附件服务: `teable-develop/apps/nestjs-backend/src/features/attachments/`
- 计算服务: `teable-develop/apps/nestjs-backend/src/features/calculation/`

### 技术文档
- [核心功能对比分析报告](./核心功能对比分析报告.md)
- [Grid-Table-Kanban 技术分析](./grid-table-kanban技术分析.md)
- [缺失功能清单](./缺失功能清单.md)

---

## ✅ 每日检查清单

### 开发前
- [ ] 拉取最新代码
- [ ] 检查相关 Issue 和 PR
- [ ] 回顾今日任务

### 开发中
- [ ] 遵循代码规范
- [ ] 编写单元测试
- [ ] 更新文档

### 开发后
- [ ] 代码自测
- [ ] 提交 PR
- [ ] 更新任务状态

---

**更新频率**: 每周五更新进度和调整计划
**负责人**: 开发团队
**开始日期**: 2025-10-09

