# Teable 新系统功能完善 - 详细实施计划

> 短期（1-2周）+ 中期（1-2个月）实施方案
> 
> 开始时间: 2025-10-09

---

## 📋 总体目标

### 第一阶段目标（1-2 周）
完善 Grid View 核心功能，使系统达到基本可用状态

**目标完成度**: 40% → 55%

### 第二阶段目标（1-2 个月）
补充关键字段类型，实现复杂数据关系

**目标完成度**: 55% → 75%

---

## 🎯 第一阶段：Grid View 核心功能（1-2 周）

### 任务 1: Filter（过滤）功能 ⭐⭐⭐

**优先级**: 🔴 最高  
**预计工时**: 3-4 天  
**状态**: 🔄 进行中

#### 功能需求

1. **过滤条件构建器**
   - 支持多条件组合（AND/OR）
   - 支持各种字段类型的过滤
   - 支持嵌套条件组

2. **字段类型过滤规则**
   ```typescript
   Text:      contains, does not contain, is, is not, is empty, is not empty
   Number:    =, !=, >, <, >=, <=, is empty, is not empty
   Select:    is, is not, is any of, is none of, is empty, is not empty
   Date:      is, is before, is after, is within, is empty, is not empty
   Boolean:   is checked, is not checked
   Rating:    =, !=, >, <, >=, <=, is empty, is not empty
   ```

3. **UI 组件**
   - Filter 按钮和面板
   - 条件编辑器
   - 条件预览

#### 实施步骤

**Step 1: 分析旧系统实现（0.5 天）**
```typescript
// 查看旧系统 Filter 实现
文件位置:
- apps/nextjs-app/src/features/app/blocks/view/grid/components/FieldMenu.tsx
- packages/core/src/models/view/filter.ts
- packages/sdk/src/components/filter/
```

**Step 2: 设计 Filter 数据结构（0.5 天）**
```typescript
// src/types/filter.ts
export interface IFilter {
  conjunction: 'and' | 'or'
  filterSet: IFilterItem[]
}

export interface IFilterItem {
  fieldId: string
  operator: FilterOperator
  value: any
}

export type FilterOperator = 
  | 'is' | 'isNot' | 'isEmpty' | 'isNotEmpty'
  | 'contains' | 'doesNotContain'
  | 'isGreaterThan' | 'isLessThan'
  | 'isAnyOf' | 'isNoneOf'
  // ... 更多操作符
```

**Step 3: 实现 Filter UI 组件（1.5 天）**
```typescript
// src/components/filter/FilterBuilder.tsx
// src/components/filter/FilterCondition.tsx
// src/components/filter/FilterOperatorSelect.tsx
// src/components/filter/FilterValueInput.tsx
```

**Step 4: 实现 Filter 逻辑（1 天）**
```typescript
// src/lib/filter-engine.ts
export function applyFilter(
  records: IRowData[], 
  filter: IFilter,
  fields: IField[]
): IRowData[] {
  // 实现过滤逻辑
}
```

**Step 5: 集成到 Grid（0.5 天）**
```typescript
// 在 FullFeaturedDemo.tsx 中集成
const [filter, setFilter] = useState<IFilter | null>(null)
const filteredData = useMemo(() => {
  if (!filter) return data
  return applyFilter(data, filter, fields)
}, [data, filter, fields])
```

#### 验收标准

- [ ] 可以创建、编辑、删除过滤条件
- [ ] 支持 AND/OR 组合逻辑
- [ ] 支持所有基础字段类型的过滤
- [ ] Filter 状态可以保存和恢复
- [ ] UI 交互流畅，无性能问题

---

### 任务 2: Sort（排序）功能 ⭐⭐⭐

**优先级**: 🔴 最高  
**预计工时**: 2-3 天  
**状态**: ⏸️ 待开始

#### 功能需求

1. **多字段排序**
   - 支持多字段组合排序
   - 支持升序/降序
   - 支持拖拽调整排序优先级

2. **字段类型排序规则**
   ```typescript
   Text:      A-Z, Z-A
   Number:    1-9, 9-1
   Date:      oldest-newest, newest-oldest
   Select:    按选项顺序
   Boolean:   checked first, unchecked first
   Rating:    lowest-highest, highest-lowest
   ```

3. **UI 组件**
   - Sort 按钮和面板
   - 排序规则列表
   - 排序预览

#### 实施步骤

**Step 1: 分析旧系统实现（0.5 天）**
```typescript
// 查看旧系统 Sort 实现
文件位置:
- packages/core/src/models/view/sort.ts
- apps/nextjs-app/src/features/app/blocks/view/grid/
```

**Step 2: 设计 Sort 数据结构（0.5 天）**
```typescript
// src/types/sort.ts
export interface ISort {
  sortObjs: ISortItem[]
  manualSort?: boolean
}

export interface ISortItem {
  fieldId: string
  order: 'asc' | 'desc'
}
```

**Step 3: 实现 Sort UI 组件（1 天）**
```typescript
// src/components/sort/SortBuilder.tsx
// src/components/sort/SortItem.tsx
// src/components/sort/SortDirectionToggle.tsx
```

**Step 4: 实现 Sort 逻辑（0.5 天）**
```typescript
// src/lib/sort-engine.ts
export function applySort(
  records: IRowData[], 
  sort: ISort,
  fields: IField[]
): IRowData[] {
  // 实现排序逻辑
}
```

**Step 5: 集成到 Grid（0.5 天）**

#### 验收标准

- [ ] 可以添加、删除、调整排序规则
- [ ] 支持多字段排序
- [ ] 支持所有字段类型的排序
- [ ] 排序状态可以保存和恢复
- [ ] 性能良好（万级数据排序 < 100ms）

---

### 任务 3: 记录详情展开 ⭐⭐⭐

**优先级**: 🔴 高  
**预计工时**: 3-4 天  
**状态**: ⏸️ 待开始

#### 功能需求

1. **详情页面**
   - 侧边栏或模态框展示
   - 显示所有字段
   - 支持编辑
   - 支持切换上/下一条记录

2. **功能组件**
   - 字段值展示
   - 字段编辑器
   - 评论区（暂时留空）
   - 历史记录（暂时留空）

3. **交互方式**
   - 点击行展开
   - 点击展开按钮
   - 键盘快捷键（Space）

#### 实施步骤

**Step 1: 分析旧系统实现（0.5 天）**
```typescript
// 查看旧系统实现
文件位置:
- packages/sdk/src/components/expand-record/
- apps/nextjs-app/src/components/expand-record-container/
```

**Step 2: 设计详情页组件（0.5 天）**
```typescript
// src/components/record-detail/RecordDetailPanel.tsx
// src/components/record-detail/RecordDetailHeader.tsx
// src/components/record-detail/RecordDetailFields.tsx
// src/components/record-detail/RecordFieldEditor.tsx
```

**Step 3: 实现基础 UI（1.5 天）**
- 使用 Sheet 或 Dialog 组件
- 布局设计
- 响应式适配

**Step 4: 实现编辑功能（1 天）**
- 字段编辑器集成
- 数据更新逻辑
- 验证和错误处理

**Step 5: 实现导航功能（0.5 天）**
- 上一条/下一条
- 键盘快捷键
- 关闭功能

#### 验收标准

- [ ] 可以展开任意记录
- [ ] 显示所有字段值
- [ ] 可以编辑字段值
- [ ] 可以导航到相邻记录
- [ ] UI 美观，交互流畅
- [ ] 支持键盘操作

---

### 任务 4: CSV 导入功能 ⭐⭐

**优先级**: 🟡 中  
**预计工时**: 2-3 天  
**状态**: ⏸️ 待开始

#### 功能需求

1. **文件上传**
   - 支持拖拽上传
   - 支持文件选择
   - 文件大小限制（如 10MB）

2. **数据解析**
   - 自动检测编码（UTF-8, GBK）
   - 解析 CSV 格式
   - 预览数据

3. **字段映射**
   - 自动匹配字段
   - 手动调整映射
   - 字段类型验证

4. **导入执行**
   - 批量创建记录
   - 进度显示
   - 错误处理

#### 实施步骤

**Step 1: 分析旧系统实现（0.5 天）**
```typescript
// 查看旧系统实现
文件位置:
- apps/nextjs-app/src/features/app/blocks/import-table/
```

**Step 2: 实现文件上传（0.5 天）**
```typescript
// src/components/import/FileUploader.tsx
```

**Step 3: 实现 CSV 解析（1 天）**
```typescript
// src/lib/csv-parser.ts
import Papa from 'papaparse'

export function parseCSV(file: File): Promise<ParseResult> {
  // 使用 papaparse 解析
}
```

**Step 4: 实现字段映射 UI（1 天）**
```typescript
// src/components/import/FieldMapper.tsx
```

**Step 5: 实现导入逻辑（0.5 天）**
```typescript
// 批量创建记录
```

#### 验收标准

- [ ] 可以上传 CSV 文件
- [ ] 正确解析 CSV 数据
- [ ] 可以映射字段
- [ ] 成功导入数据
- [ ] 有错误提示和处理

---

## 🎯 第二阶段：关键字段类型（1-2 个月）

### 任务 5: Attachment（附件）字段 ⭐⭐⭐

**优先级**: 🔴 最高  
**预计工时**: 1.5-2 周  
**状态**: ⏸️ 待开始

#### 功能需求

1. **文件上传**
   - 支持多文件上传
   - 拖拽上传
   - 粘贴上传
   - 文件类型限制
   - 文件大小限制

2. **文件管理**
   - 文件列表显示
   - 文件预览（图片、PDF）
   - 文件下载
   - 文件删除

3. **存储方案**
   - 后端文件存储服务
   - 文件 URL 生成
   - 缩略图生成

#### 实施步骤

**Step 1: 分析旧系统实现（1 天）**
```typescript
// 查看旧系统实现
文件位置:
- apps/nestjs-backend/src/features/attachments/
- packages/sdk/src/components/cell-value/cell-attachment/
```

**Step 2: 实现后端文件上传服务（3 天）**
```typescript
// 需要在后端添加：
// - 文件上传 API
// - 文件存储（本地或云存储）
// - 缩略图生成
// - 文件访问 URL
```

**Step 3: 实现前端上传组件（2 天）**
```typescript
// src/components/field-editors/AttachmentEditor.tsx
// src/components/attachment/FileUploader.tsx
// src/components/attachment/FileList.tsx
```

**Step 4: 实现文件预览（2 天）**
```typescript
// src/components/attachment/FilePreview.tsx
// 支持图片、PDF 预览
```

**Step 5: 集成到 Grid（1 天）**
```typescript
// 单元格渲染
// 编辑器集成
```

#### 验收标准

- [ ] 可以上传多个文件
- [ ] 支持拖拽和粘贴上传
- [ ] 可以预览图片和 PDF
- [ ] 可以下载和删除文件
- [ ] 文件正确存储在服务器
- [ ] 缩略图正常显示

---

### 任务 6: Link（关联）字段 ⭐⭐⭐

**优先级**: 🔴 最高  
**预计工时**: 2-3 周  
**状态**: ⏸️ 待开始

#### 功能需求

1. **关联关系**
   - 一对多关联
   - 多对多关联
   - 自关联

2. **关联选择器**
   - 搜索记录
   - 选择记录
   - 创建新记录
   - 取消关联

3. **关联显示**
   - 显示关联记录数量
   - 展开查看关联记录
   - 跳转到关联记录

4. **后端支持**
   - 关联关系存储
   - 关联查询优化
   - 级联删除配置

#### 实施步骤

**Step 1: 分析旧系统实现（2 天）**
```typescript
// 查看旧系统实现
文件位置:
- packages/core/src/models/field/derivate/link.field.ts
- apps/nestjs-backend/src/features/calculation/link.service.ts
- packages/sdk/src/components/cell-value/cell-link/
```

**Step 2: 设计关联数据结构（1 天）**
```typescript
// 关联字段配置
export interface ILinkFieldOptions {
  foreignTableId: string
  relationship: 'manyOne' | 'manyMany'
  symmetricFieldId?: string  // 对称字段
}

// 关联数据
export interface ILinkCellValue {
  id: string
  title?: string
}[]
```

**Step 3: 实现后端关联服务（5 天）**
```typescript
// 需要实现：
// - 创建关联字段 API
// - 关联关系表
// - 查询关联记录
// - 添加/删除关联
// - 级联操作
```

**Step 4: 实现前端关联选择器（4 天）**
```typescript
// src/components/field-editors/LinkEditor.tsx
// src/components/link/LinkRecordSelector.tsx
// src/components/link/LinkedRecordsList.tsx
```

**Step 5: 实现关联显示（2 天）**
```typescript
// 单元格渲染
// 展开查看
```

**Step 6: 集成和测试（2 天）**

#### 验收标准

- [ ] 可以创建 Link 字段
- [ ] 可以选择关联记录
- [ ] 可以取消关联
- [ ] 关联数据正确保存
- [ ] 可以查看关联记录详情
- [ ] 性能良好（千级关联查询 < 200ms）

---

### 任务 7: Lookup（查找）字段 ⭐⭐⭐

**优先级**: 🔴 高  
**预计工时**: 1.5-2 周  
**状态**: ⏸️ 待开始

#### 功能需求

1. **查找配置**
   - 选择 Link 字段
   - 选择要查找的字段
   - 选择查找方式（第一个、全部、聚合）

2. **查找结果**
   - 显示查找值
   - 自动更新
   - 格式化显示

3. **聚合查找**
   - Count（计数）
   - Sum（求和）
   - Average（平均）
   - Max/Min（最大/最小）

#### 实施步骤

**Step 1: 分析旧系统实现（1 天）**
```typescript
// 查看旧系统实现
文件位置:
- packages/core/src/models/field/derivate/lookup.field.ts
- apps/nestjs-backend/src/features/calculation/
```

**Step 2: 设计 Lookup 数据结构（1 天）**
```typescript
export interface ILookupFieldOptions {
  linkFieldId: string        // 关联字段
  lookupFieldId: string       // 要查找的字段
  lookupType: 'first' | 'all' | 'aggregate'
  aggregateFunction?: 'count' | 'sum' | 'average' | 'max' | 'min'
}
```

**Step 3: 实现后端查找服务（4 天）**
```typescript
// 需要实现：
// - Lookup 字段计算
// - 自动依赖追踪
// - 自动更新机制
// - 性能优化（批量计算）
```

**Step 4: 实现前端配置 UI（2 天）**
```typescript
// src/components/field-configs/LookupFieldConfig.tsx
```

**Step 5: 实现显示组件（1 天）**
```typescript
// 单元格渲染
```

**Step 6: 集成和测试（2 天）**

#### 验收标准

- [ ] 可以创建 Lookup 字段
- [ ] 可以配置查找规则
- [ ] 查找结果正确
- [ ] 自动更新工作正常
- [ ] 支持聚合查找
- [ ] 性能良好

---

## 📅 时间规划

### 第一阶段时间表（1-2 周）

```
Week 1:
  Day 1-2:  Filter 功能分析和设计
  Day 3-4:  Filter UI 和逻辑实现
  Day 5:    Filter 集成和测试

Week 2:
  Day 6-7:  Sort 功能实现
  Day 8-10: 记录详情展开实现
  Day 11-12: CSV 导入实现
  Day 13-14: 整体测试和优化
```

### 第二阶段时间表（1-2 个月）

```
Week 3-4:   Attachment 字段实现
Week 5-7:   Link 字段实现
Week 8-9:   Lookup 字段实现
Week 10:    整体测试和优化
```

---

## 🔧 技术准备

### 开发环境

```bash
# 安装依赖
cd /Users/leven/space/easy/easydb/teable-ui
npm install papaparse @types/papaparse    # CSV 解析
npm install react-dropzone                # 文件上传
npm install @tanstack/react-query         # 数据获取（如果没有）
```

### 创建目录结构

```bash
mkdir -p src/components/filter
mkdir -p src/components/sort
mkdir -p src/components/record-detail
mkdir -p src/components/import
mkdir -p src/components/attachment
mkdir -p src/components/link
mkdir -p src/lib/engines
mkdir -p src/types
```

---

## 📊 进度追踪

### 完成度指标

| 阶段 | 目标 | 当前 | 进度 |
|------|------|------|------|
| 第一阶段 | 55% | 40% | 0/4 任务完成 |
| 第二阶段 | 75% | 40% | 0/3 任务完成 |

### 任务状态

- 🔄 进行中: 1
- ⏸️ 待开始: 6
- ✅ 已完成: 0

---

## 🎯 验收标准

### 第一阶段验收

- [ ] Filter 功能可用，支持基础字段类型
- [ ] Sort 功能可用，支持多字段排序
- [ ] 记录详情可展开和编辑
- [ ] CSV 导入可正常工作
- [ ] 所有功能性能良好
- [ ] UI 美观，交互流畅
- [ ] 代码质量良好，有适当注释

### 第二阶段验收

- [ ] Attachment 字段完整可用
- [ ] Link 字段完整可用
- [ ] Lookup 字段完整可用
- [ ] 字段间依赖关系正确
- [ ] 性能满足要求
- [ ] 错误处理完善

---

## 💡 实施建议

### 开发原则

1. **参考旧系统**: 充分学习旧系统的实现方式
2. **渐进式开发**: 先实现基础功能，再逐步完善
3. **测试驱动**: 编写单元测试和集成测试
4. **代码复用**: 提取公共组件和工具函数
5. **性能优先**: 关注性能，避免不必要的重渲染

### 注意事项

1. **数据结构兼容**: 尽量与旧系统数据结构兼容
2. **API 设计**: 设计清晰的 API 接口
3. **错误处理**: 完善的错误提示和处理
4. **用户体验**: 流畅的交互和友好的提示
5. **文档更新**: 及时更新文档和注释

---

## 📝 下一步行动

### 立即开始

1. ✅ 创建实施计划文档（已完成）
2. 🔄 开始 Filter 功能分析
3. ⏸️ 准备开发环境
4. ⏸️ 创建项目目录结构

### 本周目标

- 完成 Filter 功能的设计和开发
- 开始 Sort 功能的开发

---

**准备好开始了吗？让我们从 Filter 功能开始！** 🚀

