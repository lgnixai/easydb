# API 设计规范

## RESTful API 设计原则

### 1. URL 设计规范

#### 资源命名
```
✅ 好的做法：
GET    /api/v1/users              # 获取用户列表
GET    /api/v1/users/{id}         # 获取单个用户
POST   /api/v1/users              # 创建用户
PUT    /api/v1/users/{id}         # 更新用户
DELETE /api/v1/users/{id}         # 删除用户

GET    /api/v1/users/{id}/orders  # 获取用户的订单列表
POST   /api/v1/orders             # 创建订单
GET    /api/v1/orders/{id}        # 获取订单详情

❌ 坏的做法：
GET  /api/v1/getUsers             # 不要在URL中使用动词
POST /api/v1/user/create          # 不要使用动词
GET  /api/v1/user_list            # 使用连字符而非下划线
GET  /api/v1/Users                # 使用小写
```

#### 命名规范
- **使用名词**：URL应该表示资源，使用名词而非动词
- **使用复数**：集合资源使用复数形式 `/users` 而非 `/user`
- **小写字母**：URL使用小写字母
- **连字符分隔**：使用连字符 `-` 而非下划线 `_`
- **层级关系**：体现资源间的层级关系

### 2. HTTP 方法使用

```
GET     /resources         # 获取资源列表（安全、幂等）
GET     /resources/{id}    # 获取单个资源（安全、幂等）
POST    /resources         # 创建资源（非幂等）
PUT     /resources/{id}    # 完整更新资源（幂等）
PATCH   /resources/{id}    # 部分更新资源（非幂等）
DELETE  /resources/{id}    # 删除资源（幂等）

# 非CRUD操作使用POST + 动词
POST    /orders/{id}/cancel      # 取消订单
POST    /orders/{id}/pay         # 支付订单
POST    /users/{id}/activate     # 激活用户
POST    /password/reset          # 重置密码
```

### 3. 查询参数

#### 分页
```
GET /api/v1/users?page=1&page_size=20
GET /api/v1/users?offset=0&limit=20

响应中包含分页信息：
{
  "data": [...],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 100,
    "total_pages": 5
  }
}
```

#### 过滤
```
GET /api/v1/users?status=active
GET /api/v1/users?role=admin&status=active
GET /api/v1/orders?created_at_gte=2024-01-01
```

#### 排序
```
GET /api/v1/users?sort=created_at          # 升序
GET /api/v1/users?sort=-created_at         # 降序（使用-前缀）
GET /api/v1/users?sort=name,-created_at    # 多字段排序
```

#### 搜索
```
GET /api/v1/users?q=john                   # 全文搜索
GET /api/v1/users?name_like=john           # 模糊匹配
```

### 4. HTTP 状态码

#### 成功响应（2xx）
```
200 OK              # 成功获取资源或更新成功
201 Created         # 成功创建资源
202 Accepted        # 请求已接受，但处理未完成（异步操作）
204 No Content      # 成功但无返回内容（如DELETE成功）
```

#### 客户端错误（4xx）
```
400 Bad Request            # 请求参数错误
401 Unauthorized           # 未认证
403 Forbidden              # 已认证但无权限
404 Not Found              # 资源不存在
409 Conflict               # 资源冲突（如邮箱已存在）
422 Unprocessable Entity   # 请求格式正确但语义错误（验证失败）
429 Too Many Requests      # 请求过多（限流）
```

#### 服务器错误（5xx）
```
500 Internal Server Error  # 服务器内部错误
502 Bad Gateway           # 网关错误
503 Service Unavailable   # 服务不可用
504 Gateway Timeout       # 网关超时
```

## 请求和响应格式

### 1. 统一响应格式

#### 成功响应
```json
// 单个资源
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "name": "John Doe",
  "status": "active",
  "created_at": "2024-01-01T00:00:00Z"
}

// 资源列表
{
  "data": [
    {"id": "1", "name": "User 1"},
    {"id": "2", "name": "User 2"}
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 100,
    "total_pages": 5
  }
}
```

#### 错误响应
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "验证失败",
    "details": [
      {
        "field": "email",
        "message": "邮箱格式无效"
      },
      {
        "field": "password",
        "message": "密码长度至少8位"
      }
    ]
  }
}
```

### 2. 时间格式

```json
// ✅ 使用ISO 8601格式（UTC时间）
{
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-01T12:30:45.123Z"
}

// ❌ 避免使用时间戳或其他格式
{
  "created_at": 1704067200,          // Unix时间戳
  "updated_at": "2024-01-01 12:30:45" // 非标准格式
}
```

### 3. 字段命名

```json
// ✅ 使用snake_case
{
  "user_id": "123",
  "created_at": "2024-01-01T00:00:00Z",
  "first_name": "John"
}

// ❌ 避免使用其他格式
{
  "userId": "123",        // camelCase
  "CreatedAt": "...",     // PascalCase
  "user-id": "123"        // kebab-case
}
```

## 版本控制

### URL版本化（推荐）
```
GET /api/v1/users
GET /api/v2/users

优点：
- 直观明了
- 易于缓存
- 易于路由

缺点：
- URL会变化
```

### 版本策略
- 重大不兼容更改时才增加版本号
- 保持向后兼容时不增加版本
- 同时维护2-3个版本
- 提前通知废弃计划

## 认证和授权

### 1. Bearer Token认证
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

实现示例：
POST /api/v1/auth/login
{
  "email": "user@example.com",
  "password": "password123"
}

响应：
{
  "access_token": "eyJhbGci...",
  "refresh_token": "eyJhbGci...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

### 2. 权限控制
```
// 返回403 Forbidden
{
  "error": {
    "code": "FORBIDDEN",
    "message": "您没有权限执行此操作"
  }
}
```

## 限流和速率控制

### 1. 响应头
```
X-RateLimit-Limit: 1000        # 限制总数
X-RateLimit-Remaining: 999     # 剩余次数
X-RateLimit-Reset: 1640995200  # 重置时间（Unix时间戳）
```

### 2. 超限响应
```
HTTP/1.1 429 Too Many Requests
Retry-After: 60

{
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "请求过于频繁，请稍后再试",
    "retry_after": 60
  }
}
```

## 批量操作

### 批量创建
```
POST /api/v1/users/batch

{
  "users": [
    {"email": "user1@example.com", "name": "User 1"},
    {"email": "user2@example.com", "name": "User 2"}
  ]
}

响应：
{
  "created": [
    {"id": "1", "email": "user1@example.com"}
  ],
  "failed": [
    {"email": "user2@example.com", "error": "邮箱已存在"}
  ]
}
```

## 异步操作

### 长时间运行的操作
```
POST /api/v1/data/import

// 返回202 Accepted
HTTP/1.1 202 Accepted
Location: /api/v1/jobs/job-123

{
  "job_id": "job-123",
  "status": "processing",
  "status_url": "/api/v1/jobs/job-123"
}

// 查询任务状态
GET /api/v1/jobs/job-123

{
  "job_id": "job-123",
  "status": "completed",
  "progress": 100,
  "result": {
    "imported": 1000,
    "failed": 5
  }
}
```

## 最佳实践总结

1. **一致性**：保持API设计的一致性
2. **可预测性**：遵循约定，让API行为可预测
3. **自描述**：通过字段名和结构自我解释
4. **版本化**：提供版本控制和向后兼容
5. **错误处理**：提供清晰的错误信息
6. **安全性**：使用HTTPS，实现认证授权
7. **文档化**：提供详细的API文档
8. **性能**：支持分页、缓存、压缩
9. **监控**：记录API使用情况和错误
10. **测试**：提供API测试和示例
