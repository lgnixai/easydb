# 公式编辑器实现文档

## 概述

本文档描述了公式类虚拟字段配置部分的完整实现，包括公式编辑器弹窗功能。

## 功能特性

### 1. 公式编辑器弹窗 (`FormulaEditorDialog`)

- **完整的公式编辑界面**：包含标题栏、公式输入区域、标签页等
- **双标签页设计**：
  - 编辑公式：提供字段引用、函数帮助等功能
  - AI生成公式：通过AI助手生成公式（预留接口）
- **左侧字段引用面板**：
  - 显示所有可用字段
  - 点击字段可插入到公式中
  - 显示字段类型标签
  - 支持整表引用
- **右侧功能面板**：
  - 选中字段的详细信息
  - 常用函数列表和帮助
  - 函数点击插入功能

### 2. 公式字段配置组件 (`FormulaFieldConfig`)

- **简化的配置界面**：显示当前公式状态
- **一键打开编辑器**：点击"编辑公式"按钮打开完整编辑器
- **公式预览**：实时显示配置的公式内容
- **返回类型选择**：支持text、number、boolean、date等类型

## 文件结构

```
teable-ui/src/components/
├── FormulaEditorDialog.tsx          # 公式编辑器弹窗组件
├── field-configs/
│   └── FormulaFieldConfig.tsx       # 公式字段配置组件（已更新）
├── FormulaEditorTest.tsx            # 测试组件
└── ui/                              # UI组件库
    ├── dialog.tsx
    ├── scroll-area.tsx
    ├── badge.tsx
    └── ...
```

## 使用方法

### 1. 在字段创建对话框中使用

当用户选择"Formula"字段类型时，会自动显示公式配置组件：

```tsx
import { FormulaFieldConfig } from './field-configs'

// 在CreateFieldDialog中
{fieldType === 'formula' && (
  <FormulaFieldConfig
    value={formulaConfig}
    onChange={setFormulaConfig}
    availableFields={availableFields}
  />
)}
```

### 2. 直接使用公式编辑器

```tsx
import FormulaEditorDialog from './FormulaEditorDialog'

const [isOpen, setIsOpen] = useState(false)
const [formula, setFormula] = useState('')

<FormulaEditorDialog
  open={isOpen}
  onOpenChange={setIsOpen}
  value={formula}
  onChange={setFormula}
  availableFields={fields}
  onSubmit={(formula) => {
    console.log('公式已提交:', formula)
  }}
/>
```

## 界面设计

### 公式编辑器弹窗布局

```
┌─────────────────────────────────────────────────────────┐
│ 公式编辑器                    [格式优化] [帮助中心] [×]  │
├─────────────────────────────────────────────────────────┤
│ 请输入公式                                                │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ {字段A} + {字段B} * 2                              │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                   [确认] │
├─────────────────────────────────────────────────────────┤
│ [编辑公式] [AI生成公式]                                  │
├─────────────┬───────────────────────────────────────────┤
│ 字段引用    │ 字段详情 / 函数帮助                         │
│ ┌─────────┐ │ ┌─────────────────────────────────────────┐ │
│ │A 文本   │ │ │ 文本                                    │ │
│ │[Tab]    │ │ │ 数据表的一列，返回当前行中该列对应的值...│ │
│ └─────────┘ │ └─────────────────────────────────────────┘ │
│ ┌─────────┐ │ ┌─────────────────────────────────────────┐ │
│ │单选     │ │ │ 常用函数                                │ │
│ │[Tab]    │ │ │ ┌─────────────────────────────────────┐ │ │
│ └─────────┘ │ │ │ SUM    求和                          │ │ │
│ ┌─────────┐ │ │ │ SUM({字段1}, {字段2})               │ │ │
│ │日期     │ │ │ └─────────────────────────────────────┘ │ │
│ │[Tab]    │ │ └─────────────────────────────────────────┘ │
│ └─────────┘ │                                             │
│ ┌─────────┐ │                                             │
│ │附件     │ │                                             │
│ │[Tab]    │ │                                             │
│ └─────────┘ │                                             │
│             │                                             │
│ 整表引用    │                                             │
│ ┌─────────┐ │                                             │
│ │邮寄地址 │ │                                             │
│ └─────────┘ │                                             │
└─────────────┴─────────────────────────────────────────────┘
```

## 技术实现

### 1. 状态管理

- 使用React useState管理弹窗开关状态
- 公式内容通过props双向绑定
- 选中字段状态独立管理

### 2. 交互功能

- **字段插入**：点击字段或Tab按钮插入到光标位置
- **函数插入**：点击函数自动插入并定位光标
- **公式格式化**：自动添加空格提升可读性
- **光标定位**：插入内容后自动设置光标位置

### 3. 响应式设计

- 使用Tailwind CSS实现响应式布局
- 支持不同屏幕尺寸的适配
- 弹窗最大宽度和高度限制

## 测试

### 测试页面

访问 `/formula-test` 路由可以查看完整的测试页面，包括：

1. 创建字段功能测试
2. 公式编辑器弹窗测试
3. 字段引用和函数插入测试
4. 公式提交和显示测试

### 测试用例

- [x] 弹窗打开/关闭
- [x] 字段引用插入
- [x] 函数插入和光标定位
- [x] 公式格式化
- [x] 公式提交
- [x] 响应式布局

## 扩展功能

### 1. AI生成公式

预留了AI生成公式的接口，可以通过以下方式扩展：

```tsx
const handleAIGenerate = async (prompt: string) => {
  // 调用AI API生成公式
  const generatedFormula = await aiService.generateFormula(prompt)
  setFormula(generatedFormula)
}
```

### 2. 公式验证

可以添加公式语法验证功能：

```tsx
const validateFormula = (formula: string) => {
  // 验证公式语法
  // 返回验证结果和错误信息
}
```

### 3. 公式预览

可以添加实时公式计算结果预览：

```tsx
const [previewResult, setPreviewResult] = useState('')
// 根据示例数据计算并显示结果
```

## 总结

公式编辑器功能已经完全实现，提供了完整的用户界面和交互体验。用户可以：

1. 通过字段创建对话框选择Formula字段类型
2. 点击"编辑公式"按钮打开公式编辑器
3. 在编辑器中引用字段、使用函数、格式化公式
4. 提交公式并保存配置

整个实现遵循了现代React开发最佳实践，具有良好的可维护性和扩展性。
