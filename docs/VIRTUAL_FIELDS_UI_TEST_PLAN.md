# 🧪 虚拟字段 UI 自动化测试计划

## 🎯 测试目标

通过浏览器自动化测试前端虚拟字段功能，验证：
1. ✅ Formula（公式）字段的创建和计算
2. ✅ Lookup（查找）字段的创建和显示
3. ✅ Rollup（汇总）字段的创建和统计
4. ✅ AI 字段的创建和配置

## 📋 测试前提条件

### 已有数据
- ✅ 用户账号: admin@126.com / Pmker123
- ✅ 测试空间: 测试空间 (spc_Sg1bsbjYSXW6OzFvZoRB3)
- ✅ CMS数据库: CMS数据库 (bse_r5UFpeO8ANVF4cBVDFMpq)
- ✅ 博客文章表: 5篇文章，包含字段：
  - 标题 (text)
  - 作者 (text)
  - 内容 (text)
  - 分类 (select)
  - 状态 (select)
  - 发布日期 (date)
  - 阅读量 (number)

### 环境要求
- 🌐 前端应用运行在: http://localhost:5173
- 🔧 后端API运行在: http://localhost:8080
- 🎭 浏览器: Chrome/Chromium

## 🧪 测试用例

### 测试用例 1: Formula 字段 - 字数统计

**目标**: 创建一个计算内容字数的公式字段

**步骤**:
1. 访问博客文章表
2. 点击"添加字段"按钮
3. 切换到"虚拟字段"标签
4. 选择"Formula"类型
5. 配置字段:
   - 名称: "字数统计"
   - 公式: `LEN({内容})`
   - 返回类型: number
6. 点击"创建字段"
7. 验证新列已添加
8. 验证每行都显示字数

**预期结果**:
- ✅ 字段创建成功
- ✅ 显示绿色计算器图标
- ✅ 每篇文章显示正确的字数
- ✅ 状态显示为"计算中"然后变为正常

---

### 测试用例 2: Formula 字段 - 发布天数

**目标**: 创建一个计算发布天数的公式字段

**步骤**:
1. 点击"添加字段"
2. 选择"Formula"类型
3. 配置:
   - 名称: "发布天数"
   - 公式: `DATEDIFF(TODAY(), {发布日期})`
   - 返回类型: number
4. 创建并验证

**预期结果**:
- ✅ 显示距离发布的天数
- ✅ 草稿文章显示负数或特殊值

---

### 测试用例 3: Formula 字段 - 综合信息

**目标**: 创建一个拼接多个字段的公式

**步骤**:
1. 点击"添加字段"
2. 选择"Formula"类型
3. 配置:
   - 名称: "文章概览"
   - 公式: `CONCAT({标题}, " - ", {作者}, " (", {阅读量}, "次阅读)")`
   - 返回类型: text
4. 创建并验证

**预期结果**:
- ✅ 显示格式化的综合信息
- ✅ 例如: "欢迎使用 Teable - Admin (1250次阅读)"

---

### 测试用例 4: Lookup 字段测试

**前置条件**: 需要先创建作者表和Link字段

**步骤**:
1. 创建"作者"表，包含字段：
   - 姓名
   - 邮箱
   - 简介
2. 在博客表中创建Link字段关联作者表
3. 创建Lookup字段:
   - 名称: "作者邮箱"
   - 关联字段: 作者Link
   - 查找字段: 邮箱
4. 验证显示

**预期结果**:
- ✅ 显示蓝色眼睛图标
- ✅ 自动从关联表获取数据
- ✅ 当关联改变时自动更新

---

### 测试用例 5: Rollup 字段测试

**前置条件**: 需要有多对多关联

**步骤**:
1. 创建"评论"表
2. 创建Link字段关联博客文章
3. 创建Rollup字段:
   - 名称: "评论总数"
   - 关联字段: 评论Link
   - 汇总字段: 任意字段
   - 汇总方式: COUNT
4. 验证统计

**预期结果**:
- ✅ 显示橙色趋势图标
- ✅ 显示正确的评论数量
- ✅ 当添加评论时自动更新

---

### 测试用例 6: AI 字段 - 自动摘要

**目标**: 创建一个自动生成文章摘要的AI字段

**步骤**:
1. 点击"添加字段"
2. 选择"AI"类型
3. 配置:
   - 名称: "AI摘要"
   - AI操作: 生成内容 (generate)
   - 提示词: "请为以下文章生成一段简短的摘要（不超过100字）：{{内容}}"
   - 引用字段: 内容
   - Temperature: 0.7
   - MaxTokens: 200
4. 创建字段

**预期结果**:
- ✅ 显示紫色星星图标
- ✅ 初始状态显示"计算中"（旋转加载图标）
- ✅ 几秒后显示AI生成的摘要
- ✅ 如果出错显示红色警告图标

---

### 测试用例 7: AI 字段 - 内容分类

**目标**: 让AI自动分类文章

**步骤**:
1. 创建AI字段
2. 配置:
   - 名称: "AI分类建议"
   - AI操作: 分类 (classify)
   - 提示词: "根据标题和内容，将文章分类为以下类别之一：产品介绍、技术教程、产品动态、案例分享。标题：{{标题}}，内容：{{内容}}"
   - 引用字段: 标题, 内容
3. 创建并等待计算

**预期结果**:
- ✅ 显示准确的分类建议
- ✅ 可以与实际分类字段对比

---

### 测试用例 8: AI 字段 - 关键词提取

**目标**: 从内容中提取关键词

**步骤**:
1. 创建AI字段
2. 配置:
   - 名称: "关键词"
   - AI操作: 提取 (extract)
   - 提示词: "从以下文章中提取3-5个关键词，用逗号分隔：{{内容}}"
   - 引用字段: 内容
4. 创建并验证

**预期结果**:
- ✅ 提取出相关关键词
- ✅ 格式正确（逗号分隔）

---

### 测试用例 9: 虚拟字段状态测试

**目标**: 验证虚拟字段的各种状态显示

**测试点**:
1. **Pending 状态**:
   - 创建虚拟字段后立即查看
   - 应显示旋转的加载图标
   - 单元格显示"计算中..."

2. **正常状态**:
   - 计算完成后
   - 显示字段类型图标（绿/蓝/橙/紫）
   - 显示计算结果

3. **错误状态**:
   - 创建错误的公式（如引用不存在的字段）
   - 应显示红色警告图标
   - 悬停显示错误详情

4. **重新计算**:
   - 手动触发重新计算
   - 状态应从正常→Pending→正常

---

### 测试用例 10: 字段创建对话框 UI 测试

**目标**: 验证创建对话框的所有UI元素

**测试点**:
1. **基础字段标签**:
   - 显示9种基础字段类型
   - 每个都有图标和描述
   - 点击后高亮

2. **虚拟字段标签**:
   - 显示4种虚拟字段类型
   - 带有颜色区分的图标
   - 描述清晰

3. **配置面板**:
   - 根据选择的字段类型动态显示
   - Formula: 公式编辑器 + 函数库
   - Lookup: 关联字段选择
   - Rollup: 汇总方式选择
   - AI: 提示词编辑器 + 高级选项

4. **字段引用**:
   - 可用字段列表正确显示
   - 点击插入字段引用
   - 格式正确：`{{field_name}}`

5. **验证和提示**:
   - 必填字段验证
   - 配置预览
   - 错误提示

---

## 🎬 自动化测试脚本结构

```javascript
// 测试脚本伪代码
describe('虚拟字段 UI 测试', () => {
  before(() => {
    // 登录
    // 导航到博客表
  })

  test('创建 Formula 字段 - 字数统计', async () => {
    // 1. 点击添加字段
    await page.click('[data-testid="add-field-button"]')
    
    // 2. 切换到虚拟字段
    await page.click('[data-testid="virtual-fields-tab"]')
    
    // 3. 选择 Formula
    await page.click('[data-testid="field-type-formula"]')
    
    // 4. 输入配置
    await page.fill('[data-testid="field-name"]', '字数统计')
    await page.fill('[data-testid="formula-expression"]', 'LEN({内容})')
    
    // 5. 创建
    await page.click('[data-testid="create-field-button"]')
    
    // 6. 验证
    await page.waitForSelector('[data-field-name="字数统计"]')
    const cells = await page.$$('[data-field-name="字数统计"] .cell')
    expect(cells.length).toBe(5) // 5篇文章
  })

  test('创建 AI 字段 - 自动摘要', async () => {
    // ... AI字段测试
  })

  // 更多测试...
})
```

---

## 🔍 验证检查点

### UI 层面
- [ ] 字段创建对话框正常打开
- [ ] 虚拟字段类型正确显示（带图标和颜色）
- [ ] 配置组件根据类型动态加载
- [ ] 字段引用可以点击插入
- [ ] 创建成功后对话框关闭

### 功能层面
- [ ] 新字段出现在表格中
- [ ] 字段图标正确（绿/蓝/橙/紫）
- [ ] 初始状态为"计算中"
- [ ] 计算完成后显示结果
- [ ] 错误情况显示警告图标

### 数据层面
- [ ] Formula 计算结果正确
- [ ] Lookup 查找数据正确
- [ ] Rollup 统计结果正确
- [ ] AI 生成内容合理

### 性能层面
- [ ] 页面响应流畅（< 2秒）
- [ ] 计算不阻塞UI
- [ ] 状态更新及时

---

## 📊 测试覆盖率目标

- 字段类型覆盖: 100% (4/4)
- UI组件覆盖: 100%
- API调用覆盖: 100%
- 状态场景覆盖: 100%

---

## 🐛 已知风险和注意事项

### 1. AI 字段测试
- ⚠️ 需要配置AI API密钥
- ⚠️ AI响应时间较长（5-30秒）
- ⚠️ 可能因为API限制失败

### 2. Lookup/Rollup 测试
- ⚠️ 需要先创建关联表
- ⚠️ 需要Link字段支持

### 3. 性能考虑
- ⚠️ 大量虚拟字段可能影响性能
- ⚠️ 计算密集可能导致超时

### 4. 状态监听
- ⚠️ 轮询机制可能有延迟
- ⚠️ 需要处理计算失败情况

---

## 🚀 执行计划

### 阶段 1: 环境准备 (5分钟)
1. 启动前端应用 (http://localhost:5173)
2. 启动后端服务 (http://localhost:8080)
3. 确认数据库已迁移
4. 确认博客表数据存在

### 阶段 2: Formula 字段测试 (10分钟)
- 测试用例 1: 字数统计
- 测试用例 2: 发布天数
- 测试用例 3: 综合信息

### 阶段 3: AI 字段测试 (20分钟)
- 测试用例 6: AI摘要
- 测试用例 7: 内容分类
- 测试用例 8: 关键词提取

### 阶段 4: 状态和UI测试 (10分钟)
- 测试用例 9: 状态测试
- 测试用例 10: 对话框UI测试

### 阶段 5: 验证和报告 (5分钟)
- 检查所有验证点
- 生成测试报告
- 截图保存

**总时长**: 约50分钟

---

## 📝 测试报告模板

```markdown
# 虚拟字段 UI 测试报告

## 测试概况
- 测试时间: YYYY-MM-DD HH:mm
- 测试环境: Chrome 版本
- 前端版本: v1.0.0
- 后端版本: v1.0.0

## 测试结果
- 总用例数: 10
- 通过: X
- 失败: Y
- 跳过: Z

## 详细结果
### ✅ 通过的测试
1. Formula字段 - 字数统计
   - 创建成功
   - 计算结果正确
   - 截图: [链接]

### ❌ 失败的测试
1. AI字段 - 自动摘要
   - 错误信息: API timeout
   - 截图: [链接]
   - 建议: 增加超时时间

## 性能数据
- 平均响应时间: 1.2s
- AI计算时间: 15s
- 页面加载时间: 800ms

## 结论和建议
...
```

---

## 🔧 调试技巧

1. **查看浏览器控制台**: 检查JavaScript错误
2. **查看Network标签**: 验证API调用
3. **检查后端日志**: 查看计算过程
4. **使用React DevTools**: 检查组件状态
5. **慢动作执行**: 更容易观察UI变化

---

**准备好开始测试了吗？** 🚀

下一步：启动浏览器自动化测试！



